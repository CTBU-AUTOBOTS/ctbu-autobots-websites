name: pr-validation

on:
  pull_request:
    branches: [main, dev]
    paths:
      - 'apps/home/**'
      - 'apps/docs/**'
      - '.github/workflows/**'
      - 'shared/**'

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: ğŸ” è¯†åˆ«å˜æ›´èŒƒå›´
        id: detect-changes
        run: |
          # ä½¿ç”¨ GitHub API è·å–å˜æ›´æ–‡ä»¶
          CHANGED_FILES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }}/files" \
            | jq -r '.[].filename')
          
          echo "å˜æ›´æ–‡ä»¶åˆ—è¡¨:"
          echo "$CHANGED_FILES"
          
          # è®¡ç®—å˜æ›´æ•°é‡
          HAS_HOME_CHANGES=$(echo "$CHANGED_FILES" | grep -c '^apps/home/' || echo 0)
          HAS_DOCS_CHANGES=$(echo "$CHANGED_FILES" | grep -c '^apps/docs/' || echo 0)
          
          # å§‹ç»ˆè¾“å‡ºå­—ç¬¦ä¸²ç±»å‹ï¼ˆé¿å…çº¯æ•°å­—é—®é¢˜ï¼‰
          echo "home_has_changes=$( [ $HAS_HOME_CHANGES -gt 0 ] && echo "true" || echo "false" )" >> $GITHUB_OUTPUT
          echo "docs_has_changes=$( [ $HAS_DOCS_CHANGES -gt 0 ] && echo "true" || echo "false" )" >> $GITHUB_OUTPUT
          
          # ä¿å­˜å˜æ›´æ–‡ä»¶åˆ—è¡¨
          echo "$CHANGED_FILES" > $GITHUB_WORKSPACE/changed_files.txt
          
          echo "ğŸ” å˜æ›´æ‘˜è¦:"
          echo "- ä¸»ç«™(home)å˜æ›´: ${HAS_HOME_CHANGES} ä¸ªæ–‡ä»¶"
          echo "- æ–‡æ¡£ç«™(docs)å˜æ›´: ${HAS_DOCS_CHANGES} ä¸ªæ–‡ä»¶"

      - name: âœ… éªŒè¯ PR æ ‡é¢˜æ ¼å¼
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            post
            feat
            fix
            style
            chore
            docs
            refactor
            perf
            test
            build
            ci
          scopes: |
            home
            docs
            config
            shared
          requireScope: true
          ignoreLabels: |
            ignore-semantic-pr-check
          subjectPatternError: |
            âŒ PR æ ‡é¢˜æ ¼å¼æ— æ•ˆï¼
            
            è¯·ä½¿ç”¨æ ‡å‡†æ ¼å¼: <ç±»å‹>(<ä½œç”¨åŸŸ>): <æè¿°>
            ç¤ºä¾‹: post(home): æ·»åŠ 2025å¹´ç«èµ›è·å¥–æ–°é—»
            
            å…è®¸çš„ç±»å‹: post, feat, fix, style, chore, docs, refactor, perf, test, build, ci
            å…è®¸çš„ä½œç”¨åŸŸ: home, docs, config, shared
            
            ğŸ’¡ æç¤º: ç”±äºæ˜¯å•ä»“åº“å¤šç«™ç‚¹æ¶æ„ï¼Œ
                   è¯·åœ¨æ ‡é¢˜ä¸­æ˜ç¡®æ ‡è¯†ä¿®æ”¹çš„æ˜¯ä¸»ç«™(home)è¿˜æ˜¯æ–‡æ¡£ç«™(docs)

      - name: ğŸ“‚ éªŒè¯æ–‡ä»¶ä½ç½®è§„èŒƒ
        id: file-location
        run: |
          # è¯»å–å˜æ›´æ–‡ä»¶
          if [ ! -f "$GITHUB_WORKSPACE/changed_files.txt" ]; then
            echo "âš ï¸ æœªæ£€æµ‹åˆ°å˜æ›´æ–‡ä»¶ï¼Œè·³è¿‡éªŒè¯"
            exit 0
          fi
          
          CHANGED_FILES=$(cat $GITHUB_WORKSPACE/changed_files.txt)
          
          # è·å–å¸ƒå°”æ ‡å¿—
          HOME_HAS_CHANGES="${{ steps.detect-changes.outputs.home_has_changes }}"
          DOCS_HAS_CHANGES="${{ steps.detect-changes.outputs.docs_has_changes }}"
          
          # æ£€æŸ¥ä¸»ç«™(home)å˜æ›´ä¸­æ˜¯å¦åŒ…å«æ–‡æ¡£ç«™æ–‡ä»¶
          if [ "$HOME_HAS_CHANGES" = "true" ]; then
            INVALID_DOCS_FILES=$(echo "$CHANGED_FILES" | grep '^apps/docs/' || true)
            if [ -n "$INVALID_DOCS_FILES" ]; then
              echo "âŒ é”™è¯¯: ä¸»ç«™ PR ä¸­åŒ…å«æ–‡æ¡£ç«™æ–‡ä»¶ï¼"
              echo "è¯·å°†æ–‡æ¡£ç«™ä¿®æ”¹æäº¤åˆ°ç‹¬ç«‹çš„ PRï¼Œæˆ–ä½¿ç”¨ docs ä½œç”¨åŸŸ"
              echo "è¿è§„æ–‡ä»¶ç¤ºä¾‹:"
              echo "$INVALID_DOCS_FILES" | head -3
              exit 1
            fi
          fi
          
          # æ£€æŸ¥æ–‡æ¡£ç«™(docs)å˜æ›´ä¸­æ˜¯å¦åŒ…å«ä¸»ç«™æ–‡ä»¶
          if [ "$DOCS_HAS_CHANGES" = "true" ]; then
            INVALID_HOME_FILES=$(echo "$CHANGED_FILES" | grep '^apps/home/' || true)
            if [ -n "$INVALID_HOME_FILES" ]; then
              echo "âŒ é”™è¯¯: æ–‡æ¡£ç«™ PR ä¸­åŒ…å«ä¸»ç«™æ–‡ä»¶ï¼"
              echo "è¯·å°†ä¸»ç«™ä¿®æ”¹æäº¤åˆ°ç‹¬ç«‹çš„ PRï¼Œæˆ–ä½¿ç”¨ home ä½œç”¨åŸŸ"
              echo "è¿è§„æ–‡ä»¶ç¤ºä¾‹:"
              echo "$INVALID_HOME_FILES" | head -3
              exit 1
            fi
          fi
          
          # æ£€æŸ¥è·¨åº”ç”¨ä¿®æ”¹
          if [ "$HOME_HAS_CHANGES" = "true" ] && [ "$DOCS_HAS_CHANGES" = "true" ]; then
            echo "âš ï¸ è­¦å‘Š: æ­¤ PR åŒæ—¶ä¿®æ”¹äº†ä¸»ç«™å’Œæ–‡æ¡£ç«™"
            echo "å»ºè®®: ä¸ºä¾¿äºå®¡æŸ¥ï¼Œè¯·æ‹†åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹ PR"
            echo "å¦‚æœå¿…é¡»åˆå¹¶ï¼Œè¯·æ·»åŠ æ ‡ç­¾ 'cross-app-change'"
          fi
          
          echo "âœ… æ–‡ä»¶ä½ç½®éªŒè¯é€šè¿‡"

      - name: ğŸ“¦ æ£€æŸ¥å¤§æ–‡ä»¶æäº¤
        id: large-files
        run: |
          MAX_SIZE=20971520  # 20MB
          VIOLATIONS=0
          
          echo "ğŸ” æ£€æŸ¥æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶å¤§å°..."
          
          # é‡æ–°è·å–å˜æ›´æ–‡ä»¶
          CHANGED_FILES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }}/files" \
            | jq -r '.[].filename')
          
          while IFS= read -r file; do
            # ä»…æ£€æŸ¥ç›¸å…³ç›®å½•çš„æ–°å¢/ä¿®æ”¹æ–‡ä»¶
            if [[ "$file" == apps/home/* || "$file" == apps/docs/* ]]; then
              if [ -f "$file" ]; then
                size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)
                if [ "$size" -gt "$MAX_SIZE" ]; then
                  human_size=$(echo "scale=2; $size/1024/1024" | bc 2>/dev/null || echo "$((size/1024/1024))")
                  echo "âŒ $file ($human_size MB) è¶…è¿‡ 20MB é™åˆ¶"
                  ((VIOLATIONS++))
                fi
              fi
            fi
          done <<< "$CHANGED_FILES"
          
          if [ "$VIOLATIONS" -gt 0 ]; then
            echo ""
            echo "ğŸ›‘ æäº¤è¢«é˜»æ­¢ï¼å‘ç° $VIOLATIONS ä¸ªè¶…é™æ–‡ä»¶"
            echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š"
            echo "1. å°†å¤§æ–‡ä»¶ä¸Šä¼ è‡³é˜¿é‡Œäº‘ç›˜/è“å¥äº‘"
            echo "2. åœ¨æ–‡æ¡£ä¸­æ›¿æ¢ä¸ºç½‘ç›˜é“¾æ¥"
            exit 1
          else
            echo "âœ… æœªå‘ç°è¶…é™æ–‡ä»¶ (æ‰€æœ‰æ–‡ä»¶ < 20MB)"
          fi

      - name: ğŸ“ ç”Ÿæˆé¢„è§ˆæ‘˜è¦
        if: always()
        env:
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "## ğŸš€ é¢„è§ˆç¯å¢ƒ" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # è·å–å˜æ›´æ ‡å¿—
          HOME_HAS_CHANGES="${{ steps.detect-changes.outputs.home_has_changes }}"
          DOCS_HAS_CHANGES="${{ steps.detect-changes.outputs.docs_has_changes }}"
          
          # ä» PR HEAD SHA ä¸­æˆªå–å‰7ä½å­—ç¬¦
          SHORT_SHA=${PR_HEAD_SHA:0:7}
          
          if [ "$HOME_HAS_CHANGES" = "true" ]; then
            echo "- **ä¸»ç«™é¢„è§ˆ**: https://${SHORT_SHA}.ctbu-autobots-websites.pages.dev" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$DOCS_HAS_CHANGES" = "true" ]; then
            echo "- **æ–‡æ¡£ç«™é¢„è§ˆ**: https://${SHORT_SHA}.ctbu-autobots-docs.pages.dev" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¡ é¢„è§ˆæç¤º:" >> $GITHUB_STEP_SUMMARY
          echo "- é¢„è§ˆç¯å¢ƒé€šå¸¸åœ¨1-2åˆ†é’Ÿå†…å¯ç”¨" >> $GITHUB_STEP_SUMMARY
          echo "- å¦‚æœé“¾æ¥æ— æ³•è®¿é—®ï¼Œè¯·æ£€æŸ¥ Cloudflare Pages éƒ¨ç½²çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          
          # æ·»åŠ éªŒè¯ç»“æœæ‘˜è¦
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… éªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- PR æ ‡é¢˜æ ¼å¼: é€šè¿‡ (ç¬¦åˆ Conventional Commits è§„èŒƒ)" >> $GITHUB_STEP_SUMMARY
          echo "- æ–‡ä»¶ä½ç½®è§„èŒƒ: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "- å¤§æ–‡ä»¶æ£€æŸ¥: é€šè¿‡ (æ‰€æœ‰æ–‡ä»¶ < 20MB)" >> $GITHUB_STEP_SUMMARY
          echo "- æ„å»ºæµ‹è¯•: å·²ç¦ç”¨ï¼ˆæ ¹æ®é…ç½®ï¼‰" >> $GITHUB_STEP_SUMMARY